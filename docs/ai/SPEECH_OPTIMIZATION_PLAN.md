# 语音识别优化方案

## 当前问题分析

### 1. 内存问题
- 录音缓冲区：64KB
- Base64编码后：85KB
- JSON文档：87KB
- SSL握手需要：20-30KB
- 总需求 > 可用内存（约120KB）

### 2. SSL内存错误
```
X509 - Allocation of memory failed (-10368)
```
原因：在持有大量数据时进行SSL连接，内存不足

## 优化方案：环形缓冲区 + 分段上传

### 方案A：继续使用短语音API（推荐）
适合ESP32-S3的内存限制

#### 实现策略
1. 缩短单次录音时长
   - 从2秒降到1秒
   - 音频数据：16000 samples × 2 bytes = 32KB
   - Base64后：约43KB
   - JSON文档：约45KB
   - 总需求：约90KB（可接受）

2. 优化内存管理
   - 录音完成后立即编码
   - 编码后立即释放原始音频
   - 创建JSON前释放Base64临时变量
   - POST前再次检查并清理

3. 使用RAW格式上传（重要）
   - 不需要Base64编码
   - 直接POST二进制数据
   - 节省33%内存
   - 请求头：`Content-Type: audio/pcm;rate=16000`

### 方案B：流式WebSocket API（内存要求更高）
需要更多内存用于WebSocket连接

- WebSocket握手
- 持久连接维护  
- 多个数据帧缓冲
- 不推荐用于ESP32-S3

## 推荐实施：RAW格式上传

### 优势
1. 节省内存：不需要Base64编码
2. 降低延迟：减少编码时间
3. 简化逻辑：直接发送PCM数据

### 实现要点

#### 1. HTTP请求结构
```
POST http://vop.baidu.com/server_api?cuid=esp32&token=xxx&dev_pid=1537
Content-Type: audio/pcm;rate=16000
Content-Length: 32000

[32KB PCM二进制数据]
```

#### 2. 内存使用
- 录音缓冲：32KB（1秒）
- HTTP请求头：< 1KB
- HTTP客户端：约10KB
- SSL握手：约20KB
- 总计：约63KB

#### 3. 流程优化
```
1. 按下按钮 → LED点亮
2. 录音1秒 → 填满32KB缓冲区
3. 停止录音 → LED闪烁
4. 直接POST二进制数据（无需Base64）
5. 接收识别结果
6. 清空缓冲区，准备下次录音
```

## INMP441优化配置

根据技术手册：
- 采样率：16kHz（标准）
- 位深：24bit原始 → 转16bit PCM
- 右移位数：从32位取高16位
- DMA配置：8个缓冲区 × 1024字节

## 实施步骤

1. 修改BaiduSpeech库
   - 添加RAW格式上传方法
   - 移除Base64编码

2. 优化录音缓冲
   - 降低到1秒（32KB）
   - 使用环形缓冲（可选）

3. 改进内存管理
   - 及时释放临时变量
   - SSL前清理内存

4. 测试验证
   - 检查内存使用
   - 验证识别准确率
   - 测试SSL连接稳定性
