# RAW格式语音识别测试指南

## 测试前准备

### 1. 硬件检查
- ✓ ESP32-S3开发板已连接
- ✓ INMP441麦克风正确连接（WS=45, SCK=21, SD=47）
- ✓ MAX98357功放正确连接（WS=42, SCK=41, SD=40）
- ✓ LED灯连接到GPIO48
- ✓ 按钮连接到GPIO1（带上拉电阻或内部上拉）
- ✓ USB串口连接正常

### 2. 软件配置
- ✓ WiFi账号密码已配置（`config.h`）
- ✓ 百度API密钥已配置
- ✓ DeepSeek API密钥已配置
- ✓ PlatformIO编译成功

### 3. 上传固件
```bash
pio run -t upload
```

## 测试步骤

### 第一阶段：系统启动测试

1. 打开串口监视器
   ```bash
   pio device monitor
   ```
   或在VS Code中使用PlatformIO串口监视器（波特率：115200）

2. 观察启动日志
   期待看到：
   ```
   [SYSTEM] ESP32-S3智能语音助手启动
   [AUDIO] ✓ I2S音频接口初始化成功
   [AUDIO] 音频缓冲区: 64000 bytes (62.5 KB) - RAW格式优化
   [AUDIO] 可用内存: XXX bytes (XXX KB)  // 应>150KB
   [WIFI] 正在连接到WiFi...
   [WIFI] ✓ WiFi连接成功
   [SPEECH] ✓ 百度语音服务初始化成功
   ```

3. 检查内存状态
   启动后可用内存应该>150KB（RAW格式优化后）

### 第二阶段：录音功能测试

4. 按下按钮
   - LED应该立即点亮（指示录音中）
   - 串口输出：
     ```
     [BUTTON] *** 按钮被按下 - 开始录音 ***
     [RECORD] 开始录音...
     ```

5. 说话测试
   - 距离麦克风10-15cm
   - 清晰说出："你好"或"天气"
   - 持续1-2秒

6. 松开按钮
   - LED熄灭
   - 串口输出：
     ```
     [BUTTON] *** 按钮被松开 - 停止录音 ***
     [BUTTON] 实际录音时长: XXXX ms
     [PROCESS] 开始语音识别...（音频大小: XXXX bytes）
     ```

### 第三阶段：音频质量验证

7. 检查音频统计
   串口应显示：
   ```
   [PROCESS] 音频统计 - 平均电平: XXX, 最大电平: XXX
   ```
   
   正常值：
   - 平均电平: 100-500
   - 最大电平: 1000-20000
   
   异常情况：
   - 平均<50: 音量太小，靠近麦克风
   - 最大>20000: 音量过大，远离麦克风
   - 全为零: 麦克风连接问题

### 第四阶段：RAW格式识别测试

8. 观察识别过程
   期待看到：
   ```
   [PROCESS] 使用RAW格式识别（无Base64编码，节省33%内存）...
   [BAIDU-ASR-RAW] 开始RAW格式语音识别，音频大小: XXXX bytes
   [BAIDU-ASR-RAW] 可用内存: XXX bytes (XXX KB)  // 应>80KB
   [BAIDU-ASR-RAW] Content-Type: audio/pcm;rate=16000
   [BAIDU-ASR-RAW] 发送请求...POST前可用内存: XXX bytes
   [BAIDU-ASR-RAW] HTTP响应码: 200
   ```

9. 检查识别结果
   
   成功情况：
   ```
   [BAIDU-ASR-RAW] ✓ 识别成功: 你好
   [PROCESS] ✓ 识别结果: '你好'
   [AI] 正在生成回复...
   ```
   
   失败情况：
   ```
   [BAIDU-ASR-RAW] ✗ 错误 3307: speech quality problem
   ```
   → 音频质量问题，重新录音并靠近麦克风
   
   ```
   [BAIDU-ASR-RAW] ✗ 错误 3314: no valid data
   ```
   → 音频无效，检查麦克风连接

### 第五阶段：内存监控

10. 记录关键节点内存
    
    | 阶段 | 期望可用内存 | 实际内存 | 状态 |
    |------|-------------|----------|------|
    | 系统启动后 | >150KB | _____ KB | ✓/✗ |
    | 录音开始前 | >140KB | _____ KB | ✓/✗ |
    | 录音结束后 | >80KB | _____ KB | ✓/✗ |
    | SSL连接前 | >50KB | _____ KB | ✓/✗ |
    | 识别完成后 | >100KB | _____ KB | ✓/✗ |

## 常见问题排查

### Q1: SSL连接失败（-10368）
现象：
```
[BAIDU-ASR-RAW] ✗ HTTP错误 -10368
```

原因：内存不足（RAW格式应该已解决）

排查：
1. 检查录音前可用内存是否>80KB
2. 确认录音时长≤2秒
3. 重启设备清空内存碎片

### Q2: 音频全为零
现象：
```
[PROCESS] ✗ 音频数据全为零，麦克风或I2S配置问题
```

排查：
1. 检查麦克风接线：WS=45, SCK=21, SD=47
2. 确认麦克风供电正常（3.3V）
3. 检查I2S驱动是否正确安装
4. 测量麦克风SD引脚是否有数据波形

### Q3: 识别率低
现象：识别结果不正确或为空

优化建议：
1. 距离：保持10-15cm最佳距离
2. 音量：正常说话音量，不要太小声或大声
3. 发音：清晰、标准的普通话
4. 环境：安静环境，减少背景噪音
5. 时长：1-2秒足够，不要太短或太长
6. 内容：短语或单词，不要太长句子

### Q4: 按钮无响应
现象：按钮按下，LED不亮

排查：
1. 检查按钮接线：连接到GPIO1和GND
2. 确认按钮类型（常开/常闭）
3. 检查内部上拉是否启用
4. 串口查看按钮状态日志

## 性能基准

### 内存使用（RAW格式优化后）
- 启动后: ~160KB可用
- 录音中: ~80KB可用（64KB音频缓冲）
- 识别中: ~50KB可用（SSL连接）
- 完成后: ~140KB可用（释放缓冲区）

### 时间性能
- 录音时长: 1-2秒
- 上传时间: 1-3秒（取决于网络）
- 识别时间: 1-2秒（百度服务器处理）
- 总响应时间: 3-7秒

### 识别率预期
- 清晰短语: >90%
- 常用词汇: >85%
- 长句子: >70%
- 嘈杂环境: >60%

## 成功标志

完整的成功测试应该看到：

```
[BUTTON] *** 按钮被按下 - 开始录音 ***
[RECORD] 开始录音...
... 说话 1-2秒 ...
[BUTTON] *** 按钮被松开 - 停止录音 ***
[PROCESS] 音频统计 - 平均电平: 245, 最大电平: 8567
[PROCESS] ✓ 音频电平正常
[PROCESS] 使用RAW格式识别（无Base64编码，节省33%内存）...
[BAIDU-ASR-RAW] 开始RAW格式语音识别，音频大小: 26842 bytes
[BAIDU-ASR-RAW] 可用内存: 89456 bytes (87.4 KB)
[BAIDU-ASR-RAW] HTTP响应码: 200
[BAIDU-ASR-RAW] ✓ 识别成功: 你好
[AI] 正在生成回复...
[AI] ✓ 回复: 你好！有什么可以帮助你的吗？
```

## 数据记录模板

测试日期：______
固件版本：______
测试人员：______

| 测试项 | 结果 | 备注 |
|--------|------|------|
| 系统启动 | ✓/✗ | |
| WiFi连接 | ✓/✗ | |
| 音频初始化 | ✓/✗ | |
| 按钮响应 | ✓/✗ | |
| LED指示 | ✓/✗ | |
| 录音功能 | ✓/✗ | 音频电平:___ |
| RAW上传 | ✓/✗ | 可用内存:___ |
| 语音识别 | ✓/✗ | 识别结果:___ |
| AI对话 | ✓/✗ | |
| 语音合成 | ✓/✗ | |

总体评价：□优秀 □良好 □合格 □不合格

## 下一步

测试成功后，可以尝试：
1. 调整录音时长（修改`MAX_RECORD_TIME`）
2. 测试不同音量和距离
3. 记录识别率统计
4. 优化DeepSeek对话质量
5. 如需更长录音，考虑实现流式上传
